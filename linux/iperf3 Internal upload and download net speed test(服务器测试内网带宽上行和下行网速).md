# 背景
需要对服务器的内网上下行带宽进行测试，便于判断当前带宽是否符合业务场景需求，在网上找到了iperf3工具。

iperf3是用来测量一个网络最大带宽的工具。
它支持调节各种参数比如发送持续时间，
发送/接收缓存，
通信协议。
每次测试，它都会报告网络带宽，丢包率和其他参数。

# 安装
使用iperf3工具测试服务器带宽，它分为服务端与客户端，两边都要安装iperf3工具。

```
#1、安装
yum install -y iperf3

#2、启动
# 以2228端口启动iperf服务，如端口被占用可修改为其它端口
iperf3 -p 2228 -s -D
```

# 使用
linux服务端ip：192.168.1.212
linux客户端ip：192.168.1.8

iperf3参数详解

可以使用`iperf3 --help`查看帮助命令

* -s 在服务端模式下运行 
* -D 作为守护程序运行
* -d 进行双向测试
* -c 在客户端模式下运行，连接server端地址
* -p 指定端口（要和服务器端一致）
* -B 绑定客户端的ip地址
* -4 指定ipv4
* -f 格式化带宽数输出
* -n 指定传输的字节数
* -b 使用带宽数量 
* -u 指定udp协议
* -t 以秒为单位指定传输时间，默认10秒
* --get-server-output 获取来自服务器端的结果

## 测试网络吞吐量

```
#server端（192.168.1.212）
iperf3 -p 2228 -s -D

#client端（192.168.1.165）
iperf3 -c 192.168.1.212 -p 2228
```

## tcp上传数据带宽
```
iperf3 -c 192.168.1.212 -p 2228 -b 100M -t 20
```

## tcp下载数据带宽
说明：相比下载数据带宽测试多了一个-R参数，意为Reverse，即服务器端发送数据，客户端接收数据。
```
iperf3 -c 192.168.1.212 -p 2228 -b 100M -t 20 -R
```

## UDP上传数据带宽
说明：其中比tcp的上传数据带宽测试命令多一个-u，意为使用udp协议。
```
iperf3 -c 192.168.1.212 -p 2228 -b 100M -t 20 -u
```

## UDP下载数据带宽
```
iperf3 -c 192.168.1.212 -p 2228 -b 100M -t 20 -u -R
```

## 多并发支持
说明：此处的-P是指启用多线程，127为线程数，范围为1-128，但是使用128则会引起windows端的iperf3程序崩溃，
所以最多一台电脑可以模拟127个线程同时连接服务器。观察最后的统计结果，每个线程都有流量，
且最后SUM为100M满速即可。当然，-R和-u都是可以使用的，但是使用-u只能实现90个线程同时测试，
超过90个线程软件最后会出现假死状态。

```
iperf3 -c 192.168.1.212 -p 2228 -i 20 -t 20 -P 10 
# -i, --interval  #         seconds between periodic bandwidth reports
```

## 稳定性测试
说明：-t是设置时间，3600为持续测试3600s，即1小时。
测试思路是可以通过增加时间来评估稳定性，如测试1小时（t的取值范围并未注明，但是10小时是可以的）。
当然-P -u -R都是可选的参数。

```
iperf3 -c 192.168.1.212 -p 2228 -t 3600
```